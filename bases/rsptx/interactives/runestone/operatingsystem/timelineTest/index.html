<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Tree Visualization</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div id="tree-container"></div>
    <script src="treeBuilder.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // const code = genRandSourceCode(5, 4, true, true, true, false); // Adjust the parameters
            const code = "F()F(F()F()F(),aF())"
            const [tree, codeC] = buildAndTranspile(code);
            console.log(code);
            console.log(printTreeVert(tree));
            const serializedTree = tree.serialize();
            drawTree(serializedTree);
        });
        function timelineFormat(d) {
            // idk how the spacing works ;-; but it does
          const XSPC = -25;
          const YSPC = 50;
          let gapX = 0;
          let gapY = 0;
          if (!d.children || d.children.length === 0) {
              return XSPC;
          }
          for (const child of d.children) {
            if (child.data.id == d.data.id) {
              child.x = d.x;
              child.y = d.y+YSPC;
              gapX += timelineFormat(child);
            }
            else {
              child.x = d.x+gapX+XSPC;
              child.y = d.y;
              gapY += timelineFormat(child);
            }
          }
          return gapX + gapY + 0.5*XSPC;
        }

        function drawTree(data) {
            const margin = { top: 20, right: 120, bottom: 20, left: 120 };
            const width = document.documentElement.clientWidth - margin.right - margin.left;
            const height = document.documentElement.clientHeight - margin.top - margin.bottom;
            
            const svg = d3.select("#tree-container").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const root = d3.hierarchy(data);
            const treeLayout = d3.tree().size([height, width]);
            treeLayout(root);
            timelineFormat(root)

            const nodes = svg.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr("transform", function(d) {
                    return "translate(" + d.y + "," + d.x + ")";
                });


            nodes.append('text')
                .attr("dy", "-.35em")
                .attr("x", function(d) { return d.children ? -13 : 13; })
                .style("text-anchor", function(d) { return d.children ? "start" : "end"; })
                // .text(function(d) { return d.data.value;});
                .text(function(d) { return d.data.id+"."+d.data.childCt+":"+d.data.value; });
                
            nodes.append('circle')
                .attr('r', 2);

            // const links = svg.selectAll(".link")
            //     .data(root.links())
            //     .enter()
            //     .append("path")
            //     .attr("class", "link")
            //     .attr("d", d3.linkHorizontal()
            //         .x(function(d) { return d.y; })
            //         .y(function(d) { return d.x; }));
            const links = svg.selectAll(".link")
                .data(root.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal()
                    .x(function(d) { return d.y; })
                    .y(function(d) { return d.x; }))
                .style("stroke-dasharray", (d) => d.source.data.id === d.target.data.id ? "5,5" : "0");  // Conditional dotted line

        }
    </script>
</body>
</html>
